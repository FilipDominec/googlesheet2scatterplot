<!DOCTYPE html>

<head>
<meta charset="UTF-8"> 

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- 
<script src="plotly-latest.min.js"></script> --> <!-- OPTIONAL for speedup, you can download plotly directly to this directory - and uncomment  --> 

<script src="csvToArray.js"></script>
<link rel="shortcut icon" href="favicon.png">

<title>gsheet2plotly</title>
<style type="text/css"> 
	body  { font-family: sans; background:silver; }
	td  { border:2px solid gray; padding:4px;  border-radius:10px; background:white; }
	input { vertical-align:middle;  margin: -1px 3px; } 
	label:hover { color: blue; background:#def; }
	div.sep { border-top:2px solid #aaa; color: #666; background:#eee; margin-top:5px; } </style>
</head>

<body>
<center><div id="display">gsheet2plotly initializing...</div></center>

<table align="center">
<tr>
	<td>					<div id="area" style="width:900px;height:900px;"></div> </td>
	<td> <B>X axis</B><br> 	<div id="X axis parameter"></div> </td>
	<td> <B>Y axis</B><br>	<div id="Y axis parameter"> </div> </td>
	<td> <B>Color</B><br>	<div id="Color-coded parameter"> </div> </td>
</tr>
<tr>
	<td> 
		<input type="checkbox" id="xlog"		       	onclick="axes_update()"><label for="xlog">Logarithmic X axis</label><br>
		<input type="checkbox" id="ylog"		       	onclick="axes_update()"><label for="ylog">Logarithmic Y axis</label><br>
		<input type="checkbox" id="ids"			checked	onclick="axes_update()"><label for="ids">Annotate sample IDs</label><br>
		<input type="checkbox" id="arrows"				onclick="axes_update()"><label for="arrows">Draw inheritance arrows <i>(experimental)</i></label><br>
		<input type="checkbox" id="difflabels"			onclick="axes_update()"><label for="difflabels">Print inheritance differences <i>(experimental)</i></label><br>
	</td>
	<td colspan="3"> 
		<b>Filter</b><br>
		<select id="cmbFilterBy1" size=0 onchange='axes_update(this);'> <option title='(show all)' value='tags'>tags</option> </select> 
		<select id="cmbFilterOp1" size=0 onchange='axes_update(this);'> 
		 <option title='contains XXX' value='contains'  onselect='axes_update(this);'>string contains</option>
		 <option title='gt' value='gt'  onselect='axes_update(this);'>is greater than</option>
		 <option title='eq' value='eq'  onselect='axes_update(this);'>is equal to</option>
		 <option title='lt' value='lt'  onselect='axes_update(this);'>is less than</option>
		</select>
		<input type="text" id="edtFilterParam1" size=30 onchange='axes_update(this);'> 
		
		<!--
		<hr>
		<select id="cmbFilterAndOr" size=0 onchange='axes_update(this);'> 
		 <option title='and' value='and'  onselect='axes_update(this);'>and simultaneously</option>
		 <option title='or' value='or'  onselect='axes_update(this);'>or</option>
		</select>

		<hr>
		<select id="cmbFilterBy2" size=0 onchange='axes_update(this);'> <option title='(show all)' value='(show all)'>(show all)</option> </select>
		<select id="cmbFilterOp2" size=0 onchange='axes_update(this);'> 
		 <option title='gt' value='gt'  onselect='axes_update(this);'>is greater than</option>
		 <option title='eq' value='eq'  onselect='axes_update(this);'>is equal to</option>
		 <option title='lt' value='lt'  onselect='axes_update(this);'>is less than</option>
		 <option title='contains' value='contains'  onselect='axes_update(this);'>string contains</option>
		</select>
		<input type="text" id="edtFilterParam2" size=30 onchange='axes_update(this);'> 

		<center>
		<input type="checkbox" id="ancestry" onclick="axes_update()" disabled=1><label for="ancestry" title='to be added'>Include ancestry</label> &nbsp; &nbsp; &nbsp;
		<input type="checkbox" id="descendants" onclick="axes_update()" disabled=1><label for="descendants" title='to be added'>Include descendants</label>
		</center>
		-->
	</td>
</tr>
</table>

<center> <b> Google sheet for Plotly</b> (c) Filip Dominec (2018-2020) using javascript, HTML, the great <a href="https://plot.ly">Plotly</a> library and <a href="https://docs.google.com/spreadsheets">google documents</a></br> To share your choice of axes and colors, copy the full path from your address bar.<br> To edit the data, ask for editing permissions for the underlying Google spreadsheet. <br> To make a new plot of your own data, <b><a href='./howto.html'>follow the howto</a></b>. To contribute to the source code, see git repository at <a href="https://bitbucket.org/fdominec/gsheet2plotly/">https://bitbucket.org/fdominec/gsheet2plotly/</a>.  </center> 
<script>


/**
 * JavaScript Get URL Parameter from https://www.kevinleary.net/javascript-get-url-parameters/
 * 
 * @param String prop The specific URL parameter you want to retreive the value for
 * @return String|Object If prop is provided a string value is returned, otherwise an object of all properties is returned
 */


var url_string = window.location.href;
var url = new URL(url_string);
var googleid = url.searchParams.get("googleid");  
//window.googleDocCallback = function () { return true; };
//var csvurl = proxy + 'https://docs.google.com/spreadsheets/d/e/' + googleid + '/pub?output=csv&range=A1:ZZ9999&callback=googleDocCallback';
var csvurl = 'https://docs.google.com/spreadsheets/d/e/' + googleid + '/pub?output=csv&range=A1:AZ9999'; // XXX
document.getElementById("display").innerHTML = 'gsheet2plotly waiting to receive data from Google spreadsheet address:<br><small>'+ csvurl + '</small>';


// Some static settings
var defaultparam_x = url.searchParams.get("x");
var defaultparam_y = url.searchParams.get("y");
var defaultparam_c = url.searchParams.get("c");

// Get the data from google table
var raw_text_table = '(no table loaded yet)';
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function () {
  if (xmlhttp.readyState == 4) {
	  if (xmlhttp.status == 200){
		  raw_text_table = xmlhttp.responseText;
	  } else {
		  raw_text_table = 'Error - XMLHttpRequest returned wrong status, check your browsers error console for a hint. If this happens with the official example, consider reporting a bug.';
	  };
  }
};
// document.getElementById("display").innerHTML = 'Waiting to receive data from Google docs...';
xmlhttp.open("GET", csvurl, false);
xmlhttp.send(null);				
if (googleid==null)
	document.getElementById("display").innerHTML = 'Error: Missing the google ID of the data spreadsheet. No data to show.<br> To start a new plot of your data <b><a href="./howto.html">follow the howto</a></b>' 
else
	document.getElementById("display").innerHTML = '' ;

// Process the received CSV text into a column-wise dictionaries, keyed by the column name
table = raw_text_table.csvToArray( {'rSep':'\n', 'fSep':',', 'trim':true} );
function transpose(a) {
    return Object.keys(a[0]).map(function(c) {
        return a.map(function(r) { return r[c]; });
    });
}
table = transpose(table);

var alldata = {}
var group = {}
var note = {}
for (col in table) {
	// 0th row is (descriptive) grouping of columns
	// 1st row is the real header
	// 2nd row is (descriptive) comment for users
	// 3rd+ rows are actual data
	group[table[col][1]] = table[col][0];
	alldata[table[col][1]] = table[col].slice(3);
	note[table[col][1]] = table[col][2];
}
	
// dynamic generator of radiobuttons for each sample parameter
function addradio(divname, value, selkey, note)
{
    if (value == selkey) { checked="checked='checked'"; } else { checked = ""; };
	if (value[0] != '(')
	{
		document.getElementById(divname).innerHTML = (document.getElementById(divname).innerHTML+ 
			"<label title='"+note+"'><input type='radio' class='denser' value='" + 
			value + "' name='" + divname + "' onclick='axes_update(this);' " + checked + 
			" > <span class='denser'> " + value + "</div></label><br>");
	}
}

function addseparator(divname, sepname)
{
    document.getElementById(divname).innerHTML = (document.getElementById(divname).innerHTML+ "<div class='sep'>" + sepname + "</div>");
}

function addcomboitem(comboname, value, disabled)
{
	//console.log(comboname, value);
	var select = document.getElementById(comboname);
	var option = document.createElement('option');
	option.text = option.value = value;
	option.disabled=disabled
	select.add(option);
}

colcounter = 0;
for (key in alldata) { 
	if ((group[key] != '') && (colcounter>3)) {
		addseparator('X axis parameter',	group[key]+':');
		addseparator('Y axis parameter',	group[key]+':');
		addseparator('Color-coded parameter', group[key]+':');
		addcomboitem('cmbFilterBy1', '['+group[key]+']', true);
	}
	if (!(key.startsWith("_"))) {
		addradio('X axis parameter',		key, url.searchParams.get("x"), note[key]);
		addradio('Y axis parameter',		key, url.searchParams.get("y"), note[key]);
		addradio('Color-coded parameter',	key, url.searchParams.get("c"), note[key]);
		addcomboitem('cmbFilterBy1', key, false);
	}
	colcounter += 1;
}

my_colorscale = [[0,'rgb(255,64,0)'], [0.1,'rgb(216,128,0)'], [0.2,'rgb(144,218,0)'], [0.4,'rgb(0,218,0)'],  
	  [0.6,'rgb(0,128,255)'], [.8,'rgb(64, 0, 255)'], [1,'rgb(128, 0, 128)'], ]

var sample_points = {
  x: [],
  y: [],
  text:[],
  mode:'markers',
  type:'scatter',
  textposition:'bottom center',
  marker: { size: 8, colorscale: my_colorscale },
};

var sample_textlabels = {
  x: [],
  y: [],
  text:[],
  mode:'markers+text',
  type:'scatter',
  textposition:'bottom center',
  marker: { size: 16, opacity:.2, colorscale: my_colorscale },
  showlegend: 0, // TODO: test
  hoverinfo: 'none', // TODO: test
};


var sample_rels = { x: [], y: [], mode: 'lines', color: 'grey', type: 'scatter', };
// sample_rels = { }
layout = { hovermode:'closest', showlegend: false, };
Plotly.newPlot('area', [sample_points, sample_textlabels], layout);  // {responsive: true}

function filter_points(filterby, filterop, filterpar, _data) {
	if (filterby == "(show all)") {return true}; 
	console.log("FILTERING VALUES by ", filterby, filterop, filterpar, _data.indexOf(filterpar));
	return (((filterop == "gt") && (_data > parseFloat(filterpar))) || 
					((filterop == "eq") && (_data == parseFloat(filterpar))) || 
					((filterop == "lt") && (_data < parseFloat(filterpar))) || 
					((filterop == "contains") && (_data.indexOf(filterpar) !== -1)))
}


function axes_update() {
	// determine which parameters were selected by the user
	function which_param(radios) { for (var i = 0, length = radios.length; i < length; i++) { if (radios[i].checked) { return radios[i].value; } } }
	new_x_param = which_param(document.getElementsByName('X axis parameter'))
	new_y_param = which_param(document.getElementsByName('Y axis parameter'))
	new_c_param = which_param(document.getElementsByName('Color-coded parameter'))

	// filter points (TODO)
	filterby = document.getElementById('cmbFilterBy1').value;
	filterop = document.getElementById('cmbFilterOp1').value;
	filterpar = document.getElementById('edtFilterParam1').value;
	filterlev = parseFloat(edtFilterParam1);

	//filtermode = document.getElementById('cmbFilterAndOr').value;
		  //if (filtermode == "and" && ()

	//console.log(filterby, filterop, filterpar, filterlev)

	useful_keys = ["sample ID", "parent ID", "what changed", new_x_param, new_y_param, new_c_param];

	data = {};
	for (key of useful_keys) {data[key] = []};

    for (var n=0; n<(alldata["sample ID"]).length; n++) {
		//if (alldata[filterby][n].indexOf(filterpar) != -1) {
			for (key of useful_keys) {
				data[key].push(alldata[key][n]);
			}
		//}
	}; 
	console.log(data)

					// TODO include descendants
					// TODO include ancestry


	// Update the text in the address bar
	apparent_url = url_string.split("?")[0] + "?googleid=" + googleid + "&x=" + encodeURI(new_x_param) + 
		"&y=" + encodeURI(new_y_param)+ "&c=" + encodeURI(new_c_param); // XXX add filters and axes settings
	console.log("CHANGING URL TO " + apparent_url);
	if (googleid!=null) history.pushState(null, '',  apparent_url);


	// this longer text will not be plotted - it only shows when users hover the mouse above the point
	hoverlabels = [];
	for (id of data["sample ID"]) {
		console.log("ID", id)
		parent_index = data['parent ID'][id];
		if (parent_index == -1) parentstr = "no parent" 
		else {
			parentstr = "parent " + parent_index ;
			if (data['what changed'][id] == "") 
				parentstr += " and is nominally identical to it"
			else
				parentstr += "; difference being <b>" +  data['what changed'][id] + "</b>";
		}
			

		console.log("DBG", id, new_c_param, data[new_c_param][id]);
		colorpar = data[new_c_param][id]
		if (colorpar == undefined || colorpar.trim() == "") 
			colorpar = "no " + new_c_param + " value given" 
		else 
			colorpar = new_c_param + " = " + colorpar;

		hoverlabels.push("<b>" + data['sample ID'][id] + "</b> with " + parentstr + " <br> and with " + colorpar )
	}
	sample_points['text'] 	= hoverlabels;

	// this shorter text will be (optionally) plotted
	if (document.getElementById("ids").checked == true)
		sample_textlabels["text"] 	= data["sample ID"]
	else
		sample_textlabels["text"] 	= "";

	// Load the actual sample data
	//sample_points['x'] 	= [for (d of data[new_x_param]) parseFloat(d)];
	//sample_points['y'] 	= [for (d of data[new_y_param]) parseFloat(d)];
	sample_points['x'] 	= data[new_x_param].map(d => parseFloat(d));
	sample_points['y'] 	= data[new_y_param].map(d => parseFloat(d));
	sample_points["marker"]["color"] = data[new_c_param];
	//console.log(sample_points['x'], sample_points['y']);
	sample_textlabels['x'] 	= data[new_x_param];		// NOTE: may be responsible for labels possibly disappearing in log plots!
	sample_textlabels['y'] 	= data[new_y_param];
	sample_textlabels["marker"]["color"] = data[new_c_param];
	Plotly.react('area', [sample_points, sample_textlabels, sample_rels]); 		// Replot new data and update axis labels

	// prepare annotations etc. to be updated
	layout.xaxis = {title: new_x_param};
	layout.yaxis = {title: new_y_param};                                        
	layout.annotations = [] 
	for (i=0; i<data['sample ID'].length; i++) {
		parent_index = data['sample ID'].indexOf(data['parent ID'][i].trim());
		if (parent_index != -1)  {
			//if (0) {
			if (document.getElementById("xlog").checked == true) {
				fromx = Math.log10(parseFloat(data[new_x_param][parent_index]));
				tox   = Math.log10(parseFloat(data[new_x_param][i]));
			} else {
				fromx = parseFloat(data[new_x_param][parent_index]);
				tox   = parseFloat(data[new_x_param][i]);
			};

			//if (0) {
			if (document.getElementById("ylog").checked == true) {
				fromy = Math.log10(parseFloat(data[new_y_param][parent_index])); 
				toy   = Math.log10(parseFloat(data[new_y_param][i]));
			} else {
				fromy = parseFloat(data[new_y_param][parent_index]); 
				toy   = parseFloat(data[new_y_param][i]);
			}
			diff = data['what changed'][i];
			if ((!isNaN(fromx)) && (!isNaN(tox)) && (!isNaN(fromy)) && (!isNaN(toy))) {
				//console.log('arrow is valid');
				//console.log(parent_index, diff,fromx,fromy,tox,toy);
				if (document.getElementById("difflabels").checked == true)
					layout.annotations.push({ text: diff, showarrow: false, font: { size: 12 }, xref:"x", xanchor:"center", 
							x:(fromx+tox)/2, yref:"y", yanchor:"center", y:(fromy+toy)/2 });
				if (document.getElementById("arrows").checked == true)
					layout.annotations.push({ axref:"x", ax: fromx,   aref:"x", x: tox,  ayref:"y", ay: fromy,  aref:"y", y: toy, 
						arrowhead:5, arrowcolor:"rgb(0,0,0)", opacity:.3});
			}
		}	
	}

	// Log axes
	if (document.getElementById("xlog").checked == true) layout.xaxis["type"]="log";
	if (document.getElementById("ylog").checked == true) layout.yaxis["type"]="log";

	Plotly.relayout('area', layout);
};


axes_update();
</script>

</body>
