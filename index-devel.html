<!DOCTYPE html>

<head>
<meta charset="UTF-8"> 

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- 
<script src="plotly-latest.min.js"></script> --> <!-- OPTIONAL for speedup, you can download plotly directly to this directory - and uncomment  --> 

<script src="csvToArray.js"></script>
<link rel="shortcut icon" href="favicon.png">

<title>gsheet2plotly DEVELOPMENT VERSION 2</title>
<style type="text/css"> 
	body  { font-family: sans; background:silver; }
	td  { border:2px solid gray; padding:4px;  border-radius:10px; background:white; }
	td.cs  { border:0; padding:1px; font-size:80%; text-align:center; width=20percent;}
	input { vertical-align:middle;  margin: -1px 3px; } 
	label:hover { color: blue; background:#def; }
	div.sep { border-top:2px solid #aaa; color: #444; background:#eee; margin-top:5px; } 
	div.sep:hover { color: blue; background:#bcf; } 

	div.sepnew { border-top:2px solid #8c8; color: #444; background:#bfb; margin-top:5px; } 
	div.sepnew:hover { color: blue; background:#bcf; } 

	@keyframes in { 0% { transform: scaleY(0) ; } 100% { transform: scaleY(1) ; visibility: visible; } }
	@keyframes out { 0% { transform: scaleY(1) ;  } 100% { transform: scaleY(0) ; } }
	div.show { transition: all 100ms ease-out; transform-origin: top center; animation: in 100ms ease both; }
	div.hide { transform-origin: top center; animation: out 100ms ease both; max-height:0px; }

</style>

</head>

<body>
<center><div id="display">gsheet2plotly initializing...</div></center>

<table align="center">
<tr>
	<td>
		<div id="area" style="width:900px;height:900px;"></div>
		<table style='td {padding}' border='0px' align='center'>
			<tr><td class='cs' colspan='5'>color scale for&nbsp;<span id='displaycolorquant'></span>: </td></tr>
			<tr><td class='cs'></td><td class='cs' colspan='3'><img src='my_colorscale_m.png' width='500px' height='5px'></td><td class='cs'></td></tr>
			<tr><td class='cs' colspan='2'>min</td><td class='cs'>·</td><td class='cs' colspan='2'>max</td></tr>
		</table>
	<td valign="top"> <B>X axis</B><br> <div id="X axis parameter"></div> </td>
	<td valign="top"> <B>Y axis</B><br>	<div id="Y axis parameter"></div> </td>
	<td valign="top"> <B>Color</B><br>	<div id="Color-coded parameter"> </div> </td>
</tr>
<tr>
	<td> 
		<input type="checkbox" id="xlog"		onclick="axes_update()"><label for="xlog">Logarithmic X axis</label><br>
		<input type="checkbox" id="ylog"		onclick="axes_update()"><label for="ylog">Logarithmic Y axis</label><br>
		<input type="checkbox" id="noids"		onclick="axes_update()"><label for="noids">Hide sample IDs</label><br>
		<input type="checkbox" id="arrows"		onclick="axes_update()"><label for="arrows">Draw inheritance arrows</label><br>
		<input type="checkbox" id="difflabels"	onclick="axes_update()"><label for="difflabels">Print inheritance differences</label><br>
	</td>
	<td colspan="3"> 
		<b>Filter</b><br>
		<select id="cmbFilterBy1" size=0 onchange='axes_update(this);'> <option title='(show all)' value='(show all)'>(show all)</option> </select> 
		<select id="cmbFilterOp1" size=0 onchange='axes_update(this);'> 
			<option title='eq' value='eq'  onselect='axes_update(this);'>is equal to</option>
			<option title='gt' value='gt'  onselect='axes_update(this);'>is greater than</option>
			<option title='lt' value='lt'  onselect='axes_update(this);'>is less than</option>
			<option title='contains' value='contains'  onselect='axes_update(this);'>string contains</option>
			<option title='notcontains' value='notcontains'  onselect='axes_update(this);'>string does not contain</option>
		</select>
		<input type="text" id="edtFilterParam1" size=30 onchange='axes_update(this);'> <br>
		
		<center>
		<select id="cmbFilterAndOr" size=0 onchange='axes_update(this);'> 
			<option title='and' value='and'  onselect='axes_update(this);'>and simultaneously</option>
			<option title='or' value='or'  onselect='axes_update(this);'>or</option>
		</select>
		</center>

		<select id="cmbFilterBy2" size=0 onchange='axes_update(this);'>
			<option title='(show all)' value='(show all)'>(show all)</option> </select>
		<select id="cmbFilterOp2" size=0 onchange='axes_update(this);'> 
			<option title='eq' value='eq'  onselect='axes_update(this);'>is equal to</option>
			<option title='gt' value='gt'  onselect='axes_update(this);'>is greater than</option>
			<option title='lt' value='lt'  onselect='axes_update(this);'>is less than</option>
			<option title='contains' value='contains'  onselect='axes_update(this);'>string contains</option>
			<option title='notcontains' value='notcontains'  onselect='axes_update(this);'>string does not contain</option>
		</select>
		<input type="text" id="edtFilterParam2" size=30 onchange='axes_update(this);'> 
		<hr>

		<center>
		<input type="checkbox" id="ancestry" onclick="axes_update(this)">
			<label for="ancestry" title='show also all points that are (parents of)ᴺ any shown point'>
			Include ancestry</label> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<input type="checkbox" id="descendants" onclick="axes_update(this)">
			<label for="descendants" title='show also all points which any shown point is (parent of)ᴺ'>
			Include descendants</label>
		</center>
	</td>
</tr>
</table>

<center> <b> Google sheet for Plotly</b>, updated 2021-10-25 (c) Filip Dominec (2018-2021) using javascript, HTML, the great <a href="https://plot.ly">Plotly</a> library and <a href="https://docs.google.com/spreadsheets">google documents</a></br> To share your choice of axes and colors, copy the full path from your address bar.<br> To edit the data, ask for editing permissions for the underlying Google spreadsheet. <br> To make a new plot of your own data, <b><a href='./howto.html'>follow the howto</a></b>. To contribute to the source code, see git repository at <a href="https://bitbucket.org/fdominec/gsheet2plotly/">https://bitbucket.org/fdominec/gsheet2plotly/</a>.  </center> 
<script>


/********************************************************************************
 * Getting and preprocessing the data from google table
 ********************************************************************************/

var url_string = window.location.href;
var url = new URL(url_string);
var googleid = url.searchParams.get("googleid");  
//window.googleDocCallback = function () { return true; }; // might help with cross-site troubles?
//var csvurl = proxy + 'https://docs.google.com/spreadsheets/d/e/' + googleid + '/pub?output=csv&range=A1:ZZ9999&callback=googleDocCallback';
var csvurl = 'https://docs.google.com/spreadsheets/d/e/' + googleid + '/pub?output=csv&range=A1:AP165'; // XXX
document.getElementById("display").innerHTML = 'gsheet2plotly waiting to receive data from Google spreadsheet address:<br><small>'+ csvurl + '</small>';


var raw_text_table = '(no table loaded yet)';
xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function () {
  if (xmlhttp.readyState == 4) {
	  if (xmlhttp.status == 200){
		  raw_text_table = xmlhttp.responseText;
	  } else {
		  raw_text_table = 'Error - XMLHttpRequest returned wrong status, check your browsers error console for a hint. If this happens with the official example, consider reporting a bug.';
	  };
  }
};
// document.getElementById("display").innerHTML = 'Waiting to receive data from Google docs...';
xmlhttp.open("GET", csvurl, false);
xmlhttp.send(null);				
if (googleid==null)
	document.getElementById("display").innerHTML = 'Error: Missing the google ID of the data spreadsheet. No data to show.<br> To start a new plot of your data <b><a href="./howto.html">follow the howto</a></b>' 
else
	document.getElementById("display").innerHTML = '' ;



// Process the received CSV text into a column-wise dictionaries, keyed by the column name
table = raw_text_table.csvToArray( {'rSep':'\n', 'fSep':',', 'trim':true} );
function transpose(a) {
    return Object.keys(a[0]).map(function(c) {
        return a.map(function(r) { return r[c]; });
    });
}
table = transpose(table);

var alldata = {}
var group = {}
var note = {}
for (col in table) {
	// 0th row is (descriptive) grouping of columns
	// 1st row is the real header
	// 2nd row is (descriptive) comment for users
	// 3rd+ rows are actual data
	group[table[col][1]] = table[col][0];
	alldata[table[col][1]] = table[col].slice(3);
	note[table[col][1]] = table[col][2];
}


/********************************************************************************
 * Building and User interaction of the right panel (i.e. axis choice)
 ********************************************************************************/

splitter = '&&&'
axisnames = ['X axis parameter', 'Y axis parameter', 'Color-coded parameter']

function toggle_section(by_name){
  sectname = by_name.split(splitter)[1]
  for (axisname of axisnames) {
	  var sect = document.getElementById(axisname + splitter + sectname);
	  sect.className = (sect.className !== 'show' ? 'show' : 'hide');
	  if (sect.className === 'show') {
		  sect.style.display = 'block';
	  } else {
		setTimeout(function(){ sect.style.display = 'none'; }, 100); 
	  }
  };
};

function addseparator(axisname, sectname)
{
    axis = document.getElementById(axisname)	// will be later filled with radiobuttons
	cssclass = (sectname.slice(-2) !== '*:') ? 'sep' : 'sepnew';
    axis.innerHTML = (axis.innerHTML+ 
		'<div class="' + cssclass + '"  onclick="toggle_section(\'' + axisname + splitter + sectname + '\')">' + sectname + '</div>' + 
		'<div id="' + axisname +  splitter + sectname + '" class="hide"></div>');
}

// dynamic generator of radiobuttons for each sample parameter
function addradio(axisname, sectname, optionname, selkey, note)
{
    if (optionname == selkey) { checked="checked='checked'"; } else { checked = ""; };
	if (optionname[0] != '(') {
		divname = sectname ? (axisname + splitter + sectname) : axisname; // allow adding items above 1st section
		div = document.getElementById(divname);
		if (sectname && checked) {
			for (eachaxis of axisnames) {
				document.getElementById(eachaxis+splitter+sectname).className = 'show';
			}
		}
		div.innerHTML = (div.innerHTML+ 
			"<label title='"+note+"'><input type='radio' class='denser' value='" + 
			optionname + "' name='" + axisname + "' onclick='axes_update(this);' " + checked + 
			" > <span class='denser'> " + optionname + "</span></label><br>");
	}
}

// for filtering
function addcomboitem(comboname, value, disabled)  
{
	var select = document.getElementById(comboname);
	var option = document.createElement('option');
	option.text = option.value = value;
	option.disabled=disabled
	select.add(option);
}

colcounter = 0; // cells A1, A2, A3 are not for separators, but user notes
sectname = ""; // initially, radiobuttons are added without belonging to any separator
for (key in alldata) { 
	if ((group[key] != '') && (colcounter>3)) {
		sectname = group[key]+':';
		for (axisname of axisnames) { 
			addseparator(axisname,	sectname);
		};
		addcomboitem('cmbFilterBy1', '['+group[key]+']', true);
		addcomboitem('cmbFilterBy2', '['+group[key]+']', true);
	}
	if (!(key.startsWith("_"))) {   // table columns named with leading underscore are hidden
		addradio('X axis parameter',	  sectname, key, url.searchParams.get("x"), note[key]);
		addradio('Y axis parameter',	  sectname, key, url.searchParams.get("y"), note[key]);
		addradio('Color-coded parameter', sectname, key, url.searchParams.get("c"), note[key]);
		addcomboitem('cmbFilterBy1', key, false);
		addcomboitem('cmbFilterBy2', key, false);
	}
	colcounter += 1;
}


/********************************************************************************
 * Updating user settings from URL
 ********************************************************************************/

document.getElementById("xlog").checked = (url.searchParams.get("xlog") == '1' ? true : false );
document.getElementById("ylog").checked = (url.searchParams.get("ylog") == '1' ? true : false );
document.getElementById("noids").checked = (url.searchParams.get("noids") == '1' ? true : false );
document.getElementById("arrows").checked = (url.searchParams.get("arrows") == '1' ? true : false );
document.getElementById("difflabels").checked = (url.searchParams.get("difflabels") == '1' ? true : false );

if (f = url.searchParams.get("filterby1")) { document.getElementById("cmbFilterBy1").value = f };
if (f = url.searchParams.get("filterop1")) { document.getElementById("cmbFilterOp1").value = f };
if (f = url.searchParams.get("filterparam1")) { document.getElementById("edtFilterParam1").value = f };


/********************************************************************************
 * (Re)plotting the data
 ********************************************************************************/

my_colorscale = [[0,'rgb(255,64,0)'], [0.1,'rgb(216,128,0)'], [0.2,'rgb(144,218,0)'], [0.4,'rgb(0,218,0)'],  
	  [0.6,'rgb(0,128,255)'], [.8,'rgb(64, 0, 255)'], [1,'rgb(128, 0, 128)'], ]

var sample_points = {
  x: [],
  y: [],
  text:[],
  mode:'markers',
  type:'scatter',
  textposition:'bottom center',
  marker: { size: 8, colorscale: my_colorscale },
};

var sample_textlabels = {
  x: [],
  y: [],
  text:[],
  mode:'markers+text',
  type:'scatter',
  textposition:'bottom center',
  marker: { size: 16, opacity:.2, colorscale: my_colorscale },
  showlegend: 0, 
  hoverinfo: 'none', // TODO: test
};


var sample_rels = { x: [], y: [], mode: 'lines', color: 'grey', type: 'scatter', };
layout = { hovermode:'closest', showlegend: false,responsive: true };
plot = Plotly.newPlot('area', [sample_points, sample_textlabels], layout);

function point_filter_partial(by,op,par, _data, i) {
	filterby = document.getElementById(by).value;
	filterop = document.getElementById(op).value;
	filterpar = document.getElementById(par).value;
	filterlev = parseFloat(edtFilterParam1);
	if (filterby == "(show all)") {return true}; 
	return (((filterop == "gt") && (_data[filterby][i] > parseFloat(filterpar))) || 
					((filterop == "eq") && (_data[filterby][i] == parseFloat(filterpar))) || 
					((filterop == "lt") && (_data[filterby][i] < parseFloat(filterpar))) || 
					((filterop == "contains") && (_data[filterby][i].indexOf(filterpar) !== -1)) ||
					((filterop == "notcontains") && (_data[filterby][i].indexOf(filterpar) == -1)))
}

function filter_points(_data, i) {
	filter1 = point_filter_partial('cmbFilterBy1', 'cmbFilterOp1', 'edtFilterParam1', _data, i)
	filter2 = point_filter_partial('cmbFilterBy2', 'cmbFilterOp2', 'edtFilterParam2', _data, i)

	filtermode = document.getElementById('cmbFilterAndOr').value;
	if (filtermode == "and") return (filter1 && filter2)
	else if (filtermode == "or") return (filter1 || filter2);

	// console.log("FILTERING VALUES by ", filterby, filterop, filterpar, _data.indexOf(filterpar), 'RESULT', filter1);
	return filter1
}


function axes_update() {
	// determine which parameters were selected by the user
	function which_param(radios) { for (var i = 0, length = radios.length; i < length; i++) { if (radios[i].checked) { return radios[i].value; } } }
	new_x_param = which_param(document.getElementsByName('X axis parameter'))
	new_y_param = which_param(document.getElementsByName('Y axis parameter'))
	new_c_param = which_param(document.getElementsByName('Color-coded parameter'))
	document.getElementById("displaycolorquant").innerHTML = new_c_param;

	// filter points (TODO) THIS WORKS, but the code is ugly
	filterby = document.getElementById('cmbFilterBy1').value;
	filterop = document.getElementById('cmbFilterOp1').value;
	filterlev = parseFloat(document.getElementById('edtFilterParam1').value);
	if (filterby != '(show all)') {
		data = {}
		for (key in alldata) {
		  newarr = []
		  counter = 0
		  for (d in alldata[key]) {
			if (((filterop == 'gt') && (alldata[filterby][counter] > filterlev)) || 
					((filterop == 'eq') && (alldata[filterby][counter] == filterlev)) || 
					((filterop == 'lt') && (alldata[filterby][counter] < filterlev))) {
					// TODO include descendants
					// TODO include ancestry
				newarr.push(alldata[key][d])};
				counter += 1;
		  }
		  data[key] = newarr;
		} 
	} else {
		data = alldata;
	};


	/* DISABLED TEMPORARILY - THIS DOES NOT WORK, MIXING SAMPLE NUMBERS ETC
	//console.log(filterby, filterop, filterpar, filterlev)
	useful_keys = ["sample ID", "parent ID", "what changed", new_x_param, new_y_param, new_c_param]; // Why this fails?

	data = {}; ancestry_data = {}; descent_data = {};
	for (key of useful_keys) {
		data[key] = []
		ancestry_data[key] = []
		descent_data[key] = []
	}
	for (const [i, id] of alldata['sample ID'].entries()) {
		if (filter_points(alldata, i)) {
			console.log("ADDING DATA AS IT PASSES FILTER:", alldata['sample ID'][i])
			for (key of useful_keys) {
				data[key].push(alldata[key][i]);
			}

			parent_index = alldata['sample ID'].indexOf(alldata['parent ID'][i].trim()); // TODO make this recursive
			if ((document.getElementById('ancestry').checked)  &&  (parent_index !== -1) ) { 
				console.log("ADDING DATA",   alldata['sample ID'][parent_index], " AS IT IS ANCESTOR OF:", alldata['sample ID'][i])
				for (key of useful_keys) {
					ancestry_data[key].push(alldata[key][parent_index]);
				}
			}
			*/

			/* TODO
			if (document.getElementById('descendants').checked) { 
				for (const [i, id] of alldata['sample ID'].entries()) {
					parent_index = alldata['sample ID'].indexOf(alldata['parent ID'][i].trim());
					if descent_index
				}
				for (key of useful_keys) {
					descent_data[key].push(alldata[key][parent_index]);
				}
			}
		}
	}
	// console.log('filtering', filterby, filterop, filterlev)

	// const result = words.filter(word => word.length > 6);

	//let range = { lower: 13, upper: 16 }
	//let teenagers = people.filter(function(person) { return person.age >= this.lower && person.age <= this.upper; }, range)

	*/

	// XXX if ((document.getElementsByName('ancestry').checked)  &&  dataindex ) { 
	/*
	for (const [i, id] of data['sample ID'].entries()) {
			deduplicator = ancestry_data['sample ID'].indexOf(parent_index);
			if (parent_index !== -1) {
			}
			console.log("PRESENT", id, "PARENT", data['parent ID'][i], "alldIDX", alldata['sample ID'][parent_index])
	}

	for (key of useful_keys) {
		data[key] = data[key].concat(ancestry_data[key]);
	}
	*/

	



	// Update the text in the address bar
	apparent_url = url_string.split("?")[0] + 
			"?x=" + encodeURI(new_x_param) + 
			"&y=" + encodeURI(new_y_param) + 
			"&c=" + encodeURI(new_c_param) + 
			(document.getElementById("xlog").checked ? '&xlog=1' : '') + 
			(document.getElementById("ylog").checked ? '&ylog=1' : '') + 
			(document.getElementById("noids").checked ? '&noids=1' : '') + 
			(document.getElementById("arrows").checked ? '&arrows=1' : '') + 
			(document.getElementById("difflabels").checked ? '&difflabels=1' : '') + 
			((document.getElementById("cmbFilterBy1").value !== '(show all)') ? ('&filterby1='+ document.getElementById('cmbFilterBy1').value) : '' ) +
			((document.getElementById("cmbFilterOp1").value !== 'eq') ? ('&filterop1='+ document.getElementById('cmbFilterOp1').value) : '' ) +
			((document.getElementById("edtFilterParam1").value) ? ('&filterparam1='+ document.getElementById('edtFilterParam1').value) : '' ) +
			"&googleid=" + googleid;
			//(document.getElementById("filterparam1").checked ? '&arrows=1' : '') + 
			// TODO add filters 
	if (googleid!=null) history.pushState(null, '',  apparent_url);

	// this longer text will not be plotted - it only shows when users hover the mouse above the point
	hoverlabels = [];
	for ([id, idx] of data["sample ID"].entries()) {
		parent_index = data['parent ID'][id];
		if (parent_index == -1) parentstr = "no parent"  // TODO why -1 here?
		else {
			parentstr = "parent " + parent_index ;
			if (data['what changed'][id] == "") 
				parentstr += " which is nominally identical to it"
			else
				parentstr += "; difference being <b>" +  data['what changed'][id] + "</b>";
		}
			
		colorpar = data[new_c_param][id]
		if (colorpar == undefined || colorpar.trim() == "") 
			colorpar = "no " + new_c_param + " value given" 
		else 
			colorpar = new_c_param + " = " + colorpar;

		hoverlabels.push("<b>" + data['sample ID'][id] + "</b> with " + parentstr + " <br> and with " + colorpar )
	}
	sample_points['text'] 	= hoverlabels;

	// this shorter text will be (optionally) plotted
	if (document.getElementById("noids").checked == true)
		sample_textlabels["text"] 	= "";
	else
		sample_textlabels["text"] 	= data["sample ID"]



	// Load the actual sample data (TODO: decide if parseFloat is useful here, plotly converts strings too)
	sample_points['x'] 	= data[new_x_param].map(d => parseFloat(d)); 
	sample_points['y'] 	= data[new_y_param].map(d => parseFloat(d));
	sample_points["marker"]["color"] = data[new_c_param];
	sample_textlabels['x'] 	= data[new_x_param];		// NOTE: may be responsible for labels possibly disappearing in log plots!
	sample_textlabels['y'] 	= data[new_y_param];
	sample_textlabels["marker"]["color"] = data[new_c_param];
	Plotly.react('area', [sample_points, sample_textlabels, sample_rels]); 		// Replot new data and update axis labels

	// prepare annotations etc. to be updated
	layout.xaxis = {title: new_x_param};
	layout.yaxis = {title: new_y_param};                                        
	layout.annotations = [] 
	for (i=0; i<data['sample ID'].length; i++) {
		parent_index = data['sample ID'].indexOf(data['parent ID'][i].trim());
		if (parent_index != -1)  {
			//if (0) {
			if (document.getElementById("xlog").checked == true) {
				fromx = Math.log10(parseFloat(data[new_x_param][parent_index]));
				tox   = Math.log10(parseFloat(data[new_x_param][i]));
			} else {
				fromx = parseFloat(data[new_x_param][parent_index]);
				tox   = parseFloat(data[new_x_param][i]);
			};

			//if (0) {
			if (document.getElementById("ylog").checked == true) {
				fromy = Math.log10(parseFloat(data[new_y_param][parent_index])); 
				toy   = Math.log10(parseFloat(data[new_y_param][i]));
			} else {
				fromy = parseFloat(data[new_y_param][parent_index]); 
				toy   = parseFloat(data[new_y_param][i]);
			}
			diff = data['what changed'][i];
			if ((!isNaN(fromx)) && (!isNaN(tox)) && (!isNaN(fromy)) && (!isNaN(toy))) {
				if (document.getElementById("difflabels").checked == true)
					layout.annotations.push({ text: diff, showarrow: false, font: { size: 12 }, xref:"x", xanchor:"center", 
							x:(fromx+tox)/2, yref:"y", yanchor:"center", y:(fromy+toy)/2 });
				if (document.getElementById("arrows").checked == true)
					layout.annotations.push({ axref:"x", ax: fromx,   aref:"x", x: tox,  ayref:"y", ay: fromy,  aref:"y", y: toy, 
						arrowhead:5, arrowcolor:"rgb(0,0,0)", opacity:.3});
			}
		}	
	}

	// Log axes
	if (document.getElementById("xlog").checked == true) layout.xaxis["type"]="log";
	if (document.getElementById("ylog").checked == true) layout.yaxis["type"]="log";

	Plotly.relayout('area', layout);
};

axes_update();
</script>

</body>
